<?php
error_reporting(0);
set_time_limit(0);

// Fungsi untuk memeriksa dan mengaktifkan fungsi jika belum diaktifkan
function checkAndActivateFunction($functionName) {
    if (!function_exists($functionName)) {
        echo "Error: Function '$functionName' is not enabled on the server. Please enable the required functions and try again.";
        exit();
    }
}

// Daftar fungsi yang diperlukan
$requiredFunctions = [
    'scandir',
    'is_file',
    'is_dir',
    'file_get_contents',
    'file_put_contents',
    'htmlentities',
    'strpos',
];

// Memeriksa dan mengaktifkan fungsi-fungsi yang belum diaktifkan
foreach ($requiredFunctions as $functionName) {
    checkAndActivateFunction($functionName);
}

// Mulai menjalankan tools
// ...
?>

<!DOCTYPE html>
<html>
<head>
    <title>Backdoor Scanner</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #191d2b;
            color: #fff;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #1c2331;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h2 {
            margin-bottom: 20px;
            color: #6fdbe8;
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            text-transform: uppercase;
        }

        .file-list {
            margin-bottom: 20px;
        }

        .file-list table {
            width: 100%;
            border-collapse: collapse;
        }

        .file-list th,
        .file-list td {
            padding: 8px;
            border-bottom: 1px solid #33425b;
        }

        .file-list th {
            background-color: #2c384f;
            font-weight: bold;
            color: #6fdbe8;
            text-align: left;
        }

        .file-list td.actions {
            text-align: center;
        }

        .code-container {
            margin-bottom: 20px;
        }

        .code-container pre {
            background-color: #2c384f;
            padding: 10px;
            overflow-x: auto;
            color: #fff;
        }

        .error {
            color: #ff4757;
            margin-bottom: 10px;
        }

        .success {
            color: #2ed573;
            margin-bottom: 10px;
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            background-color: #6fdbe8;
            color: #000;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .btn:hover {
            background-color: #2ed573;
        }

        .infected {
            background-color: #ff4757;
        }

        .actions form {
            display: inline-block;
        }

        .actions input[type="submit"] {           
           margin-left: 5px;
        }
        
        .scrollable-text {
            max-width: 400px;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .loading {
            margin-bottom: 10px;
            color: #2ed573;
            text-align: center;
            display: none;
        }

       select {
  padding: 8px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 4px;
  background-color: #fff;
  color: #333;
}

select:focus {
  outline: none;
  border-color: #6fdbe8;
}

select option {
  background-color: #fff;
  color: #333;
}

    </style>
</head>
<body>
    <div class="container">
        <h2>Backdoor Scanner</h2>

        <?php
        // Fungsi untuk mendapatkan daftar file di dalam direktori
        function getFiles($dir)
        {
            $files = array();
            $entries = scandir($dir);

            foreach ($entries as $entry) {
                if ($entry == '.' || $entry == '..') {
                    continue;
                }

                $path = $dir . '/' . $entry;
                if (is_file($path)) {
                    $files[] = $path;
                } elseif (is_dir($path)) {
                    $nestedFiles = getFiles($path); // Panggil fungsi secara rekursif untuk direktori yang ada di dalamnya
                    $files = array_merge($files, $nestedFiles);
                }
            }

            return $files;
        }


        // Fungsi untuk memeriksa apakah file mengandung backdoor
        function isBackdoor($file, $method)
        {
            $contents = file_get_contents($file);

            // Tambahkan deteksi backdoor sesuai dengan metode yang dipilih
            if ($method === 'base64_decode') {
                if (strpos($contents, 'base64_decode(') !== false) {
                    return true;
                }
            } elseif ($method === 'gzinflate') {
                if (strpos($contents, 'gzinflate(') !== false) {
                    return true;
                }
            } elseif ($method === 'eval') {
                if (strpos($contents, 'eval(') !== false) {
                    return true;
                }
            } elseif ($method === 'sex') {
                if (strpos($contents, 'shell_exec(') !== false) {
                    return true;
                }
            } elseif ($method === 'exec') {
                if (strpos($contents, 'exec(') !== false) {
                    return true;
                }
            } elseif ($method === 'system') {
                if (strpos($contents, 'system(') !== false) {
                    return true;
                }
            } elseif ($method === 'gzun') {
                if (strpos($contents, 'gzuncompress(') !== false) {
                    return true;
                }
            } elseif ($method === 'isread') {
                if (strpos($contents, 'is_readable(') !== false) {
                    return true;
                }
            } elseif ($method === 'iswrita') {
                if (strpos($contents, 'is_writable(') !== false) {
                    return true;
                }
            }
            
            
            
            return false;
        }

        // Fungsi untuk melihat kode file
        function viewCode($file)
        {
            $contents = htmlentities(file_get_contents($file));
            echo '<div class="code-container"><pre>' . $contents . '</pre></div>';
        }

        // Fungsi untuk menghapus kode backdoor dari file
        function deleteCode($file)
        {
            // Tulis kembali isi file yang telah diubah
            file_put_contents($file, '');

            echo '<div class="success">Kode backdoor telah dihapus dari file.</div>';
            echo '<div class="code-container"><pre>' . htmlentities($contents) . '</pre></div>';
        }

        // Memeriksa apakah tombol "View Code" telah ditekan
        if (isset($_POST['view'])) {
            $file = $_POST['file'];
            echo '<h2>View Code: ' . $file . '</h2>';
            viewCode($file);
        }

        // Memeriksa apakah tombol "Delete Code" telah ditekan
        if (isset($_POST['delete'])) {
            $file = $_POST['file'];
            echo '<h2>Delete Code: ' . $file . '</h2>';
            deleteCode($file);
        }

        // Memeriksa apakah tombol "Scan" telah ditekan
        if (isset($_POST['submit'])) {
            $directory = $_SERVER['DOCUMENT_ROOT'];
            $files = getFiles($directory);
            $infectedFiles = array();
            $scanMethod = $_POST['scanMethod'];

            // Menampilkan loading
            echo '<div class="loading" id="loading">Scanning files...</div>';
            flush();
        ?>
            <script>
                window.addEventListener('DOMContentLoaded', function () {
                    var loading = document.getElementById('loading');
                    loading.style.display = 'block';
                });
            </script>
        <?php
            flush();

            // Memeriksa setiap file untuk keberadaan backdoor
            foreach ($files as $file) {
                if (isBackdoor($file, $scanMethod)) {
                    $infectedFiles[] = $file;

                    // Output flush untuk setiap file yang terinfeksi
                    echo '<div class="file-list">';
                    echo '<table>';
                    echo '<tr><th>File</th><th>Status</th><th>Actions</th></tr>';
                    echo '<tr>';
                    echo '<td><pre class="scrollable-text">' . $file . '</pre></td>';
                    echo '<td class="error">Detected</td>';
                    echo '<td class="actions">';
                    echo '<form method="post" action="">';
                    echo '<input type="hidden" name="file" value="' . $file . '">';
                    echo '<input type="submit" name="view" value="View Code" class="btn">';
                    echo '<input type="submit" name="delete" value="Delete Code" class="btn">';
                    echo '</form>';
                    echo '</td>';
                    echo '</tr>';
                    flush();
                }
            }

            echo '</table>';
            echo '</div>';
            flush();
        }
        ?>

        <form method="post" action="">
            <div class="form-group">
                <label for="scanMethod">Scan Method:</label>
                <select name="scanMethod" id="scanMethod">
                    <option value="isread">is_readable</option>
                    <option value="iswrita">is_writable</option>
                    <option value="base64_decode">base64_decode</option>
                    <option value="gzinflate">gzinflate</option>
                    <option value="eval">eval</option>
                    <option value="sex">shell_exec</option>
                    <option value="exec">exec</option>
                    <option value="system">system</option>
                    <option value="gzun">gzuncompress</option>
                </select>
            </div>
            <input type="submit" name="submit" value="Scan" class="btn">
        </form>
    </div>
</body>
</html>
